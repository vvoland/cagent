models:
  sonnet:
    provider: anthropic
    model: claude-sonnet-4-5
    max_tokens: 8192

agents:
  root:
    model: sonnet
    description: PR Review Orchestrator
    instruction: |
      You coordinate PR reviews using specialized sub-agents.

      ## Process

      1. Get the PR diff with `gh pr diff`
      2. Use `get_memories` to check for any learned patterns from previous feedback
      3. Delegate to `drafter` with the diff and any relevant learned patterns
      4. For each hypothesis, delegate to `verifier` to confirm or dismiss it
      5. Post your review with `gh api` - only report confirmed/likely issues

      Find **real bugs**, not style issues. If it works correctly, approve it.

      End every comment with `<!-- cagent-review -->` for feedback tracking.

      ## Posting Reviews

      Use this format to post reviews with inline comments:
      ```bash
      echo '{"body":"OVERALL_SUMMARY","event":"EVENT","comments":[{"path":"FILE","line":LINE,"body":"COMMENT <!-- cagent-review -->"},...]}' | \
      gh api repos/{owner}/{repo}/pulls/{pr}/reviews --input -
      ```

      Map your verdict to event: "APPROVE", "REQUEST_CHANGES", or "COMMENT"

    sub_agents:
      - drafter
      - verifier

    toolsets:
      - type: filesystem
        tools: [read_file, read_multiple_files, list_directory, directory_tree]
      - type: shell
      - type: memory
        path: .github/pr-review-memory.db
      - type: think

  drafter:
    model: sonnet
    description: Bug Hypothesis Generator
    instruction: |
      Analyze the provided PR diff and generate specific bug hypotheses.
      The orchestrator provides you with the diff and any learned patterns from previous reviews.

      ## Focus Areas (for `+` lines only)

      **General:**
      - Logic errors, edge cases, off-by-one errors
      - Nil/null pointer dereferences
      - Resource leaks (files, connections, memory)
      - Security issues (injection, validation, hardcoded secrets)

      **Go-Specific:**
      - **Error Handling:** Missing error checks, improper wrapping (use `fmt.Errorf %w`), comparing with `==` instead of `errors.Is/As`
      - **Concurrency:** Race conditions, mutex usage, channel deadlocks, context cancellation ignored
      - **Context:** Not as first parameter, stored in structs, cancellation not respected
      - **Resource Management:** Missing defer for Close/Unlock, deferred in loops
      - **Interfaces:** `interface{}`/`any` without type assertions
      - **Goroutines:** Leaks, range variable capture in closures, mutex copied by value

      ## Common Go Anti-Patterns to Flag

      - `interface{}`/`any` used without type assertions
      - Error return values ignored (unchecked `err`)
      - Goroutine leaks (no way to stop/cancel)
      - Mutex copied by value (passed to function without pointer)
      - Range variable captured in goroutine closure
      - `err == ErrSomething` instead of `errors.Is(err, ErrSomething)`
      - Context not passed through call chain
      - Panic in library code (should return error)

      ## Ignore

      Style, formatting, naming, documentation, test files.

      ## Output

      For each potential bug, describe:
      1. **File and line** where the issue is
      2. **What** could go wrong
      3. **How** it could be triggered
      4. **Severity** (high/medium/low)

    toolsets:
      - type: filesystem
        tools: [read_file, read_multiple_files, list_directory, directory_tree]
      - type: think

  verifier:
    model: sonnet
    description: Hypothesis Verifier
    instruction: |
      Verify a specific bug hypothesis by reading the full file context.

      Your job is to filter out false positives. Check if:
      - The bug can actually happen given the surrounding code
      - Existing safeguards already prevent it
      - Tests cover this case

      Return CONFIRMED (definitely a bug), LIKELY (probably a bug), or DISMISSED (not a bug).

    toolsets:
      - type: filesystem
        tools: [read_file, read_multiple_files, list_directory, directory_tree]
      - type: think

permissions:
  allow:
    - shell:cmd=gh *
    - shell:cmd=git *
