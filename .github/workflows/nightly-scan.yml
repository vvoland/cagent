name: Nightly Codebase Scan

on:
  schedule:
    # Run every day at 6am UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Log issues only, do not create them'
        type: boolean
        default: false

permissions:
  contents: read
  issues: write

concurrency:
  group: nightly-scan
  cancel-in-progress: false

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 1

      - name: Restore scanner memory
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: ${{ github.workspace }}/.github/agents/scanner-memory.db
          key: scanner-memory-${{ github.repository }}
          restore-keys: |
            scanner-memory-${{ github.repository }}

      - name: Run nightly scan
        id: scan
        uses: docker/cagent-action@latest
        with:
          agent: ${{ github.workspace }}/.github/agents/nightly-scanner.yaml
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout: 600

      - name: Parse and create issues
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        env:
          DRY_RUN: ${{ inputs.dry-run || false }}
        with:
          script: |
            const fs = require('fs');
            const outputFile = '${{ steps.scan.outputs.output-file }}';
            const dryRun = process.env.DRY_RUN === 'true';

            if (!fs.existsSync(outputFile)) {
              console.log('No output file found');
              return;
            }

            const rawOutput = fs.readFileSync(outputFile, 'utf8');
            console.log('Raw agent output:', rawOutput);

            // Extract JSON from output (agent might include extra text)
            let issues = [];
            try {
              // Try to find JSON array in the output
              const jsonMatch = rawOutput.match(/\[[\s\S]*\]/);
              if (jsonMatch) {
                issues = JSON.parse(jsonMatch[0]);
              }
            } catch (e) {
              console.log('Failed to parse JSON:', e.message);
              console.log('Agent output was not valid JSON - skipping issue creation');
              return;
            }

            if (!Array.isArray(issues) || issues.length === 0) {
              console.log('âœ… No issues found by scanner');
              return;
            }

            console.log(`Found ${issues.length} issue(s)`);

            // Get existing open issues to avoid duplicates
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated',
              per_page: 100
            });

            const existingTitles = existingIssues.map(i => i.title.toLowerCase());

            // Limit to 2 issues per run
            const issuesToCreate = issues.slice(0, 2);
            let created = 0;

            for (const issue of issuesToCreate) {
              // Skip if similar issue already exists
              const titleLower = issue.title.toLowerCase();
              if (existingTitles.some(t => t.includes(titleLower) || titleLower.includes(t))) {
                console.log(`â­ï¸ Skipping duplicate: ${issue.title}`);
                continue;
              }

              const severityEmoji = {
                critical: 'ğŸ”´',
                high: 'ğŸŸ ',
                medium: 'ğŸŸ¡'
              }[issue.severity] || 'âšª';

              const categoryLabel = {
                security: 'kind/bug',       // security issues are bugs
                bug: 'kind/bug',
                documentation: 'kind/documentation'
              }[issue.category] || 'kind/bug';

              const body = `## ${severityEmoji} ${issue.severity.toUpperCase()} - ${issue.category}

**File:** \`${issue.file}\`${issue.line ? ` (line ${issue.line})` : ''}

### Code

\`\`\`go
${issue.code}
\`\`\`

### Problem

${issue.problem}

### Suggested Fix

${issue.suggestion}

---

*Found by [nightly codebase scan](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
`;

              if (dryRun) {
                console.log(`\nğŸ“‹ Would create issue:\n  Title: ${issue.title}\n  Labels: automated, ${categoryLabel}`);
                console.log(`  Body preview:\n${body.substring(0, 200)}...`);
              } else {
                try {
                  const { data: newIssue } = await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: `[${issue.category}] ${issue.title}`,
                    body: body,
                    labels: ['automated', categoryLabel]
                  });
                  console.log(`âœ… Created issue #${newIssue.number}: ${newIssue.html_url}`);
                  created++;
                } catch (e) {
                  console.log(`âŒ Failed to create issue: ${e.message}`);
                }
              }
            }

            if (!dryRun) {
              console.log(`\nğŸ“Š Summary: Created ${created} issue(s)`);
            }

      - name: Save scanner memory
        uses: actions/cache/save@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        if: always()
        with:
          path: ${{ github.workspace }}/.github/agents/scanner-memory.db
          key: scanner-memory-${{ github.repository }}
