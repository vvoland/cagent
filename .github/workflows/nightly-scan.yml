name: Nightly Codebase Scan

on:
  schedule:
    # Run every day at 6am UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Log issues only, do not create them'
        type: boolean
        default: false

permissions:
  contents: read
  issues: write

concurrency:
  group: nightly-scan
  cancel-in-progress: false

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 1

      - name: Restore scanner memory
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: ${{ github.workspace }}/.github/agents/scanner-memory.db
          key: scanner-memory-${{ github.repository }}
          restore-keys: |
            scanner-memory-${{ github.repository }}

      - name: Run nightly scan
        uses: docker/cagent-action@latest
        env:
          GH_TOKEN: ${{ github.token }}
          GOOGLE_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          agent: ${{ github.workspace }}/.github/agents/nightly-scanner.yaml
          prompt: ${{ inputs.dry-run && 'DRY RUN MODE: Do not create any issues. Just report what you would create.' || '' }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          timeout: 600

      - name: Save scanner memory
        uses: actions/cache/save@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        if: always()
        with:
          path: ${{ github.workspace }}/.github/agents/scanner-memory.db
          key: scanner-memory-${{ github.repository }}
