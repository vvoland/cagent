name: winget
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to publish (e.g., v1.20.5)"
        required: true
        type: string
      dry_run:
        description: "Dry run (do not submit PR)"
        required: false
        type: boolean
        default: false

env:
  WINGET_CREATE_GITHUB_TOKEN: ${{ secrets.WINGET_GH_TOKEN }}

permissions: {}

jobs:
  publish:
    runs-on: windows-latest
    steps:
      - name: publish
        env:
          VERSION: ${{ inputs.release_tag || github.event.release.tag_name }}
          DRY_RUN: ${{ inputs.dry_run || false }}
        run: |
          curl.exe -JLO https://aka.ms/wingetcreate/latest
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to download wingetcreate.exe (curl exit code: $LASTEXITCODE)"
            exit 1
          }
          if (-not (Test-Path .\wingetcreate.exe)) {
            Write-Error "wingetcreate.exe was not downloaded successfully"
            exit 1
          }
          # Verify the signature
          $sig = Get-AuthenticodeSignature .\wingetcreate.exe
          if ($sig.Status -ne 'Valid') {
            Write-Error "Invalid signature on wingetcreate.exe: $($sig.Status)"
            exit 1
          }

          $Version = $ENV:VERSION
          $DryRun = $ENV:DRY_RUN -eq 'true'
          $PackageId = "Docker.Cagent"
          $Urls = @(
            "https://github.com/docker/cagent/releases/download/$Version/cagent-windows-amd64.exe|amd64",
            "https://github.com/docker/cagent/releases/download/$Version/cagent-windows-arm64.exe|arm64"
          )
          
          # Build command with conditional -s flag
          $params = @('update', $PackageId, '-v', $Version, '-u', $Urls)
          if (-not $DryRun) {
            $params += '-s'
          }
          
          & .\wingetcreate.exe @params