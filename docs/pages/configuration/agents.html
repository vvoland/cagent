<h1>Agent Configuration</h1>
<p class="subtitle">Complete reference for defining agents in your YAML configuration.</p>

<h2>Full Schema</h2>

<pre><code class="language-yaml">agents:
  agent_name:
    model: string                  # Required: model reference
    description: string            # Required: what this agent does
    instruction: string            # Required: system prompt
    sub_agents: [list]             # Optional: sub-agent names
    toolsets: [list]               # Optional: tool configurations
    rag: [list]                    # Optional: RAG source references
    fallback:                      # Optional: fallback config
      models: [list]
      retries: 2
      cooldown: 1m
    add_date: boolean              # Optional: add date to context
    add_environment_info: boolean  # Optional: add env info to context
    add_prompt_files: [list]       # Optional: include additional prompt files
    add_description_parameter: bool # Optional: add description to tool schema
    code_mode_tools: boolean       # Optional: enable code mode tool format
    max_iterations: int            # Optional: max tool-calling loops
    num_history_items: int         # Optional: limit conversation history
    skills: boolean                # Optional: enable skill discovery
    commands:                      # Optional: named prompts
      name: "prompt text"
    welcome_message: string        # Optional: message shown at session start
    handoffs: [list]               # Optional: list of A2A handoff agents
    defer: [list] or true          # Optional: tools to load on demand
    hooks:                         # Optional: lifecycle hooks
      pre_tool_use: [list]
      post_tool_use: [list]
      session_start: [list]
      session_end: [list]
    permissions:                   # Optional: tool execution control
      allow: [list]
      deny: [list]
    sandbox:                       # Optional: shell isolation
      image: string
      paths: [list]
    structured_output:             # Optional: constrain output format
      name: string
      schema: object</code></pre>

<div class="callout callout-tip">
  <div class="callout-title">üí° See also</div>
  <p>For model parameters, see <a href="#configuration/models" onclick="event.preventDefault(); navigate('configuration/models')">Model Config</a>. For tool details, see <a href="#configuration/tools" onclick="event.preventDefault(); navigate('configuration/tools')">Tool Config</a>. For multi-agent patterns, see <a href="#concepts/multi-agent" onclick="event.preventDefault(); navigate('concepts/multi-agent')">Multi-Agent</a>.</p>
</div>

<h2>Properties Reference</h2>

<table>
  <thead>
    <tr><th>Property</th><th>Type</th><th>Required</th><th>Description</th></tr>
  </thead>
  <tbody>
    <tr>
      <td><code>model</code></td><td>string</td><td>‚úì</td>
      <td>Model reference. Either inline (<code>openai/gpt-4o</code>) or a named model from the <code>models</code> section.</td>
    </tr>
    <tr>
      <td><code>description</code></td><td>string</td><td>‚úì</td>
      <td>Brief description of the agent's purpose. Used by coordinators to decide delegation.</td>
    </tr>
    <tr>
      <td><code>instruction</code></td><td>string</td><td>‚úì</td>
      <td>System prompt that defines the agent's behavior, personality, and constraints.</td>
    </tr>
    <tr>
      <td><code>sub_agents</code></td><td>array</td><td>‚úó</td>
      <td>List of agent names this agent can delegate to. Automatically enables the <code>transfer_task</code> tool.</td>
    </tr>
    <tr>
      <td><code>toolsets</code></td><td>array</td><td>‚úó</td>
      <td>List of tool configurations. See <a href="#configuration/tools" onclick="event.preventDefault(); navigate('configuration/tools')">Tool Config</a>.</td>
    </tr>
    <tr>
      <td><code>fallback</code></td><td>object</td><td>‚úó</td>
      <td>Automatic model failover configuration.</td>
    </tr>
    <tr>
      <td><code>add_date</code></td><td>boolean</td><td>‚úó</td>
      <td>When <code>true</code>, injects the current date into the agent's context.</td>
    </tr>
    <tr>
      <td><code>add_environment_info</code></td><td>boolean</td><td>‚úó</td>
      <td>When <code>true</code>, injects working directory, OS, CPU architecture, and git info into context.</td>
    </tr>
    <tr>
      <td><code>add_prompt_files</code></td><td>array</td><td>‚úó</td>
      <td>List of file paths whose contents are appended to the system prompt. Useful for including coding standards, guidelines, or additional context.</td>
    </tr>
    <tr>
      <td><code>add_description_parameter</code></td><td>boolean</td><td>‚úó</td>
      <td>When <code>true</code>, adds agent descriptions as a parameter in tool schemas. Helps with tool selection in multi-agent scenarios.</td>
    </tr>
    <tr>
      <td><code>code_mode_tools</code></td><td>boolean</td><td>‚úó</td>
      <td>When <code>true</code>, formats tool responses in a code-optimized format with structured output schemas. Useful for MCP gateway and programmatic access.</td>
    </tr>
    <tr>
      <td><code>max_iterations</code></td><td>int</td><td>‚úó</td>
      <td>Maximum number of tool-calling loops. Default: unlimited (0). Set this to prevent infinite loops.</td>
    </tr>
    <tr>
      <td><code>num_history_items</code></td><td>int</td><td>‚úó</td>
      <td>Limit the number of conversation history messages sent to the model. Useful for managing context window size with long conversations. Default: unlimited (all messages sent).</td>
    </tr>
    <tr>
      <td><code>rag</code></td><td>array</td><td>‚úó</td>
      <td>List of RAG source names to attach to this agent. References sources defined in the top-level <code>rag</code> section. See <a href="#features/rag" onclick="event.preventDefault(); navigate('features/rag')">RAG</a>.</td>
    </tr>
    <tr>
      <td><code>skills</code></td><td>boolean</td><td>‚úó</td>
      <td>Enable automatic skill discovery from standard directories.</td>
    </tr>
    <tr>
      <td><code>commands</code></td><td>object</td><td>‚úó</td>
      <td>Named prompts that can be run with <code>cagent run config.yaml /command_name</code>.</td>
    </tr>
    <tr>
      <td><code>welcome_message</code></td><td>string</td><td>‚úó</td>
      <td>Message displayed to the user when a session starts. Useful for providing context or instructions.</td>
    </tr>
    <tr>
      <td><code>handoffs</code></td><td>array</td><td>‚úó</td>
      <td>List of A2A agent configurations this agent can delegate to. See <a href="#features/a2a" onclick="event.preventDefault(); navigate('features/a2a')">A2A Protocol</a>.</td>
    </tr>
    <tr>
      <td><code>defer</code></td><td>array/boolean</td><td>‚úó</td>
      <td>Tools to load on-demand rather than at startup. Set to <code>true</code> to defer all tools, or provide a list of tool names.</td>
    </tr>
    <tr>
      <td><code>hooks</code></td><td>object</td><td>‚úó</td>
      <td>Lifecycle hooks for running commands at various points. See <a href="#configuration/hooks" onclick="event.preventDefault(); navigate('configuration/hooks')">Hooks</a>.</td>
    </tr>
    <tr>
      <td><code>permissions</code></td><td>object</td><td>‚úó</td>
      <td>Control which tools are auto-approved, require confirmation, or are blocked. See <a href="#configuration/permissions" onclick="event.preventDefault(); navigate('configuration/permissions')">Permissions</a>.</td>
    </tr>
    <tr>
      <td><code>sandbox</code></td><td>object</td><td>‚úó</td>
      <td>Run shell commands in an isolated Docker container. See <a href="#configuration/sandbox" onclick="event.preventDefault(); navigate('configuration/sandbox')">Sandbox Mode</a>.</td>
    </tr>
    <tr>
      <td><code>structured_output</code></td><td>object</td><td>‚úó</td>
      <td>Constrain agent output to match a JSON schema. See <a href="#configuration/structured-output" onclick="event.preventDefault(); navigate('configuration/structured-output')">Structured Output</a>.</td>
    </tr>
  </tbody>
</table>

<div class="callout callout-warning">
  <div class="callout-title">‚ö†Ô∏è max_iterations</div>
  <p>Default is <code>0</code> (unlimited). Always set <code>max_iterations</code> for agents with powerful tools like <code>shell</code> to prevent infinite loops. A value of 20‚Äì50 is typical for development agents.</p>
</div>

<h2>Welcome Message</h2>

<p>Display a message when users start a session:</p>

<pre><code class="language-yaml">agents:
  assistant:
    model: openai/gpt-4o
    description: Development assistant
    instruction: You are a helpful coding assistant.
    welcome_message: |
      üëã Welcome! I'm your development assistant.
      
      I can help you with:
      - Writing and reviewing code
      - Running tests and debugging
      - Explaining concepts
      
      What would you like to work on?</code></pre>

<h2>Deferred Tool Loading</h2>

<p>Load tools on-demand to speed up agent startup:</p>

<pre><code class="language-yaml">agents:
  root:
    model: anthropic/claude-sonnet-4-0
    description: Multi-purpose assistant
    instruction: You have access to many tools.
    toolsets:
      - type: mcp
        ref: docker:github-official
      - type: mcp
        ref: docker:slack
      - type: filesystem
    # Defer all tools - load when first used
    defer: true</code></pre>

<p>Or defer specific tools:</p>

<pre><code class="language-yaml">agents:
  root:
    model: openai/gpt-4o
    defer:
      - "mcp:github:*"    # Defer all GitHub tools
      - "mcp:slack:*"     # Defer all Slack tools</code></pre>

<h2>Fallback Configuration</h2>

<p>Automatically switch to backup models when the primary fails:</p>

<table>
  <thead><tr><th>Property</th><th>Type</th><th>Default</th><th>Description</th></tr></thead>
  <tbody>
    <tr><td><code>models</code></td><td>array</td><td><code>[]</code></td><td>Fallback models to try in order</td></tr>
    <tr><td><code>retries</code></td><td>int</td><td><code>2</code></td><td>Retries per model for 5xx errors. <code>-1</code> to disable.</td></tr>
    <tr><td><code>cooldown</code></td><td>string</td><td><code>1m</code></td><td>How long to stick with a fallback after a rate limit (429)</td></tr>
  </tbody>
</table>

<p><strong>Error handling:</strong></p>
<ul>
  <li><strong>Retryable</strong> (same model with backoff): HTTP 5xx, 408, network timeouts</li>
  <li><strong>Non-retryable</strong> (skip to next model): HTTP 429, 4xx client errors</li>
</ul>

<pre><code class="language-yaml">agents:
  root:
    model: anthropic/claude-sonnet-4-0
    fallback:
      models:
        - openai/gpt-4o
        - google/gemini-2.5-flash
      retries: 2
      cooldown: 1m</code></pre>

<h2>Named Commands</h2>

<p>Define reusable prompt shortcuts:</p>

<pre><code class="language-yaml">agents:
  root:
    model: openai/gpt-4o
    instruction: You are a system administrator.
    commands:
      df: "Check how much free space I have on my disk"
      logs: "Show me the last 50 lines of system logs"
      greet: "Say hello to ${env.USER}"
      deploy: "Deploy ${env.PROJECT_NAME || 'app'} to ${env.ENV || 'staging'}"</code></pre>

<pre><code class="language-bash"># Run commands from the CLI
$ cagent run agent.yaml /df
$ cagent run agent.yaml /greet
$ PROJECT_NAME=myapp ENV=production cagent run agent.yaml /deploy</code></pre>

<p>Commands use JavaScript template literal syntax for environment variable interpolation. Undefined variables expand to empty strings.</p>

<h2>Complete Example</h2>

<pre><code class="language-yaml">models:
  claude:
    provider: anthropic
    model: claude-sonnet-4-0
    max_tokens: 64000

agents:
  root:
    model: claude
    description: Technical lead coordinating development
    instruction: |
      You are a technical lead. Analyze requests and delegate
      to the right specialist. Always review work before responding.
    welcome_message: "üëã I'm your tech lead. How can I help today?"
    sub_agents: [developer, researcher]
    add_date: true
    add_environment_info: true
    fallback:
      models: [openai/gpt-4o]
    toolsets:
      - type: think
    commands:
      review: "Review all recent code changes for issues"
    hooks:
      session_start:
        - type: command
          command: "./scripts/setup.sh"

  developer:
    model: claude
    description: Expert software developer
    instruction: Write clean, tested, production-ready code.
    max_iterations: 30
    toolsets:
      - type: filesystem
      - type: shell
      - type: think
      - type: todo
    permissions:
      allow:
        - "read_*"
        - "shell:cmd=go*"
        - "shell:cmd=npm*"
      deny:
        - "shell:cmd=sudo*"
    sandbox:
      image: golang:1.23-alpine
      paths:
        - "."

  researcher:
    model: openai/gpt-4o
    description: Web researcher with memory
    instruction: Search for information and remember findings.
    toolsets:
      - type: mcp
        ref: docker:duckduckgo
      - type: memory
        path: ./research.db</code></pre>
